<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <style>
    input {
        margin: 10px 0;
        padding: 5px;
    }
  </style>
</head>
<body>
  <!-- data binding start-->
  <div id="app1">
    <img src="https://pic3.zhimg.com/37b4f40d32a57980706d3e8a2209dcfa_200x112.png" alt="">
    value:<input type="text" p-model="name" value=""><br>
    value:<input type="text" p-model="hungry" value=""><br>
    value:<input type="text" p-model="foolish" value=""><br>
    show value:    <p>hello world! {{ name }}, stay {{hungry}}, stay {{ foolish }}</p>
  </div>
  <script>
    "use strict"
    function Pastry(conf) {
      this.data = conf.data;
      this.el = conf.el;
      this.view_input = [];
      this.old_tpl = '';
      this.init();
    }
    Pastry.prototype = {
      init: function (){
        let el = document.querySelector(this.el);
        this.view_input = el.querySelectorAll('[p-model]');
        let view_input = this.view_input;
        console.log(this.old_tpl);
        this.old_tpl = el.innerHTML;
        let _this = this;
        this.bindData(this);
      },
      bindText: function (ob){
        let el = document.querySelector(ob.el);
        let new_tpl = render( ob.old_tpl, ob.data);
        console.log(new_tpl);
        el.innerHTML = new_tpl;
        this.init();
      },
      bindData: function (ob){
        let view_input = ob.view_input;
        for(let i = 0; i < view_input.length; i++){
          console.log("bind");
          let prop = view_input[i].getAttribute("p-model");
          let _value = ob.data[prop];
          Object.defineProperty(ob.data, prop, {
            set: function (value) {
              console.log(value);
              _value = value;
              ob.bindText(ob);
            },
            get: function () {
              return _value;
            },
            enumerable: true,
            configurable: true
          })
          view_input[i].addEventListener('input', function (e){
            ob.data[e.target.getAttribute('p-model')] = e.target.value;
          });
        }
      },
    }

    let joe = new Pastry({
      el: "#app1",
      data: {
        name: "joe",
        hungry: "hungry",
        foolish: "foolish"
      }
    });



    // var Joe = {name: ""};
    // var m = document.getElementById("model");
    // var v = document.getElementById("view");
    // Object.defineProperty(Joe, "val", {
    //   set: function (value) {
    //     this.name = value;
    //     v.innerHTML = Joe.val;
    //   },
    //   get: function () {
    //     return this.name;
    //   },
    //   enumerable: true,
    //   configurable: true
    // });
    // m.addEventListener('input', function (e) {
    //   Joe.val = e.target.value;
    //   console.log(e);
    // })
  </script>

  <!-- template engine start-->
  <div id="app">
    <!-- <p>hello world! {{ name }}, stay {{hungry}}, stay {{ foolish }}</p> -->
  </div>
</body>
<script>
  "use strict"
  // window.onbeforeunload = function (){
  //   return false;
  // }
  //
  // let data = {
  //   name: "joe",
  //   hungry: "hungry",
  //   foolishs: "foolish"
  // };
  //
  // let tpl = document.querySelector("#app").innerHTML;
  function render( tpl, data){
    const REG_RENDER = /{{([^}}]+)?}}/g;
    let new_tpl = tpl.replace(REG_RENDER, function(str){
      const REG_VAL_NAME = /[^}}|{{| ]+/g;
      let valueName = REG_VAL_NAME.exec(str)[0];
      if(data[valueName]){
        return data[valueName];
      }else{
        console.error("variable [" + valueName + "] is undefined in [data]");
        return "<strong style=\"color:red;\">["+valueName+"] undefined</strong>";
      }
    });
    return new_tpl;
  }




  // let match = "";
  // let re2 = /{{([^}}]+)?}}/g;
  // while(match = re2.exec(tpl)) {
  //     console.log(match);
  // }

</script>
</html>
